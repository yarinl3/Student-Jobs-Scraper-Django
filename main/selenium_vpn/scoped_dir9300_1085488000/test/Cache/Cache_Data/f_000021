var $body="",baseUrl="",subscribeUrl="",campaignId="",templateId="",request_url="",actionUrl="",form_inputs="",editable="",screen_size="",must_redirect="",must_redirect_url="",replace_data={matches:[],selectors:[]},tmp_repl="";$(document).ready(function(){$body=$("body"),baseUrl=$('input[name="base_url"]').val(),subscribeUrl=$('input[name="subscribe_url"]').val(),campaignId=$('input[name="campaign_id"]').val(),templateId=$('input[name="template_id"]').val(),request_url=$('input[name="request_url"]').val(),actionUrl=$('input[name="action_url"]').val(),editable=parseInt($('input[name="editable"]').val()),must_redirect=$('input[name="must_redirect"]').val(),must_redirect_url=$('input[name="redirect_url"]').val(),form_inputs=getTemplateInputs(),window.addEventListener?window.addEventListener("message",receiveApiMessage,!1):void 0!==window.attachEvent&&window.attachEvent("onmessage",receiveApiMessage),window.widgetsData&&PCD.postMessage({message:"pr:widgets_data",params:JSON.stringify(widgetsData)},request_url),initTemplateEvents(),$(self).on("onPicAfterSubmit",doFromEventStack)});var getTemplateInputs=function(){return $body.find(':input[name]:not([type="button"],[type="image"],[type="reset"],[file=""],[name=""],.picreel_tech_data,[name="popup_size"],[name="timer_value"],[name="hide_close_frame"],[name="hide_close_link"],[name="wrap_background"],[name="full_width_template"],[name="message_hide_time"],[name="poweredby_color"],[name="wrap_text_color"],[name="wrap_click_close"],[name="send_leads_get"],[name="close_message_btn"],[name="corner_popup"],[name="mobile_corner"],[name="slices_data"],[name="search_personal_match"]),select[name]')},initTemplateEvents=function(){if("_blank"===$(".submit").attr("target")&&"redirect"===event_stack.onPicAfterSubmit.action){var e=event_stack.onPicAfterSubmit.parameters[0];$(".submit").attr("href",e)}$('input[type="submit"]:not(.submit)').on("click",function(e){if(e.preventDefault(),$(this).hasClass("sending"))return!1;var t=collectDataToSubmit();if(0!=t){if(!(0<campaignId))return PCD.postMessage({message:"pr:close_popup"},request_url),!1;if(0<$body.find('input[type="email"]').length){var a=$body.find('input[type="email"]').val();PCD.postMessage({message:"pr:do_custom_action",params:a},request_url)}subscribe(t,function(e){var t=function(){$(self).trigger("onPicConversion"),$.event.trigger("picDataSubmit")};ifExistingEmail(e,t)||t()});var s="";return $('input[name="template-message"]').length&&(s=$('input[name="template-message"]').val()),PCD.postMessage({message:"pr:close_after_submit",params:s},request_url),!1}}),$(".submit").click(function(e){if("_blank"!==$(this).attr("target")&&e.preventDefault(),$(this).hasClass("sending"))return!1;if($(self).trigger("onBeforeSubmit"),0<campaignId){if(0==form_inputs.length){return track_conversion(function(){!$(".container").hasClass("open-in-window")&&event_stack&&"redirect"==event_stack.onPicAfterSubmit.action&&($(self).trigger("onPicConversion"),$(self).trigger("onPicAfterSubmit"))}),event_stack&&("close"==event_stack.onPicAfterSubmit.action||$(".container").hasClass("open-in-window")&&"redirect"==event_stack.onPicAfterSubmit.action)&&($(self).trigger("onPicConversion"),$(self).trigger("onPicAfterSubmit")),!0}var a=collectDataToSubmit();if(0==a)return e.preventDefault(),!1;isBriteDocsEmail(function(){if(0<$body.find('input[type="email"]').length){var e=$body.find('input[type="email"]').val();PCD.postMessage({message:"pr:do_custom_action",params:e},request_url)}var t=function(){$(self).trigger("onPicConversion"),$(self).trigger("onPicAfterSubmit")};subscribe(a,function(e){ifExistingEmail(e,t)||!$(".container").hasClass("open-in-window")&&event_stack&&"redirect"==event_stack.onPicAfterSubmit.action&&t()}),"1"!=must_redirect&&event_stack&&("close"==event_stack.onPicAfterSubmit.action||$(".container").hasClass("open-in-window")&&"redirect"==event_stack.onPicAfterSubmit.action)&&t()})}else PCD.postMessage({message:"pr:close_popup"},request_url)}),$(".next-step-btn").on("click",function(e){if(e.preventDefault(),$(this).hasClass("sending"))return!1;var t=collectDataToSubmit();return 0!=t?(0<campaignId?isBriteDocsEmail(function(){subscribe(t,function(e){$(self).trigger("onPicConversion")}),$("#step-1").hide(),$("#step-2").show()}):($("#step-1").hide(),$("#step-2").show()),!1):void 0}),$("#submit-button-step-1").off("click").on("click",function(e){if(e.preventDefault(),$(self).trigger("onBeforeSubmit"),0==form_inputs.length)return track_conversion(),$("#step-1").hide(),$("#step-2").show(),!1;var t=collectDataToSubmit();0!=t&&(0<campaignId?isBriteDocsEmail(function(){if(0<$body.find('input[type="email"]').length){var e=$body.find('input[type="email"]').val();PCD.postMessage({message:"pr:do_custom_action",params:e},request_url)}subscribe(t,function(e){var t=function(){$(self).trigger("onPicConversion"),PCD.postMessage({message:"pr:cookie_after_submit"},request_url),$("#step-1").hide(),$("#step-2").show()};ifExistingEmail(e,t)||t()})}):($("#step-1").hide(),$("#step-2").show()))}),$("#next-step-button").on("click",function(e){return e.preventDefault(),$("#step-1").hide(),$("#step-2").show(),!1}),$(".action-button").on("click",function(e){e.preventDefault();var t=!1;if($('input[name="template-redirect-link"]').length)return $(self).trigger("onPicRedirect"),t=$('input[name="template-redirect-link"]').val(),PCD.postMessage({message:"pr:redirect",params:t},request_url),!1;var a="";return $('input[name="template-message"]').length&&(a=$('input[name="template-message"]').val()),PCD.postMessage({message:"pr:close_after_submit",params:a},request_url),!1}),$(document).on("click",".close-popup, .close",function(e){e.preventDefault(),$(self).trigger("onPicClose"),PCD.postMessage({message:"pr:close_popup"},request_url)}),$(".do-action").on("click",function(e){e.preventDefault(),track_conversion(),$(self).trigger("onPicDoAction"),PCD.postMessage({message:"pr:close_popup",params:"do-action"},request_url)}),$(document).on("click",".do-custom-action",function(e){if(!$(this).hasClass("close")&&!$(this).hasClass("submit")){e.preventDefault(),$(self).trigger("onPicCustomAction");var t=$body.find('input[type="email"]').val();PCD.postMessage({message:"pr:do_custom_action",params:t},request_url),PCD.postMessage({message:"pr:close_popup"},request_url)}}),$(".redirect").on("click",function(e){track_conversion();var t=$(this).attr("href")||$(this).find("a").attr("href");void 0!==t&&($(self).trigger("onPicRedirect"),"_blank"===$(".submit").attr("target")?PCD.postMessage({message:"pr:close_after_submit",params:""},request_url):$(".container").hasClass("open-in-window")?(e.preventDefault(),window.open(t,"Redirect window","top="+.05*screen_size.height+",left="+.05*screen_size.width+",resizable=yes,scrollbars=yes,width="+.9*screen_size.width+",height="+.8*screen_size.height),PCD.postMessage({message:"pr:close_after_submit",params:""},request_url)):(e.preventDefault(),setTimeout(function(){PCD.postMessage({message:"pr:redirect",params:t},request_url)},1500)))}),$(document).on("keyup",'input:not([type="hidden"])',function(e){if(13==e.keyCode){$(this).blur();var t=$(this).parents(".container");0==t.length&&(t=$(this).parents("#template-container"));var a=[];a.push("#submit-button"),a.push("#submit-button-step-1"),a.push(".next-step-btn"),a.push(".subscribe-data"),a.push(".submit");for(var s=0;s<a.length;s++)if(0<$(t.find(a[s])[0]).length){$(t.find(a[s])[0]).trigger("click");break}}})},setLeadDataToRedirect=function(e){var t=-1===e.parameters[0].indexOf("?")?"?":"&";return form_inputs.each(function(e){("radio"!=$(this).prop("type")&&"checkbox"!=$(this).prop("type")||("radio"==$(this).prop("type")||"checkbox"==$(this).prop("type"))&&1==$(this).prop("checked"))&&(0<e&&(t+="&"),t+=$(this).attr("name")+"="+encodeURIComponent($.trim($(this).val())))}),t},afterPopupInit=function(){var e=$('input[name="request_url"]').val(),t=$('input[name="campaign_id"]').val();t&&PCD.postMessage({message:"pr:current_campaign",params:t},e),PCD.postMessage({message:"pr:current_template",params:$('input[name="template_id"]').val()},e),$('input[name="mobile_corner"]').val()&&PCD.postMessage({message:"pr:mobile_corner"},e);var a=$('input[name="corner_popup"]').val(),s=$('input[name="popup_size"]').val();s&&(a?PCD.postMessage({message:"pr:corner_popup",params:s+"["+a+"]"},e):PCD.postMessage({message:"pr:popup_size",params:s},e));var r=$('input[name="wrap_background"]').val();r?PCD.postMessage({message:"pr:wrap_background",params:r},e):PCD.postMessage({message:"pr:wrap_background",params:"rgba(0,0,0,0.9)"},e);var i=parseInt(0<$("input.message_hide_time").length?$("input.message_hide_time").val():$('input[name="message_hide_time"]').val());i&&(i*=1e3,PCD.postMessage({message:"pr:popupTimeout",params:i},e));var n=$('input[name="periodicity"]').val();n&&PCD.postMessage({message:"pr:set_expire_time",params:n},e),parseInt($($body.find('input[name="hide_powered_link"]')[$body.find('input[name="hide_powered_link"]').length-1]).val())&&PCD.postMessage({message:"pr:hide_powered_link"},e),parseInt($($body.find('input[name="hide_close_link"]')[$body.find('input[name="hide_close_link"]').length-1]).val())&&PCD.postMessage({message:"pr:hide_close_frame"},e),parseInt($('input[name="hide_close_frame"]').val())&&PCD.postMessage({message:"pr:hide_close_frame"},e),parseInt($('input[name="close_message_btn"]').val())&&PCD.postMessage({message:"pr:close_message_btn"},e);var o=$('input[name="poweredby_color"]').val();o&&PCD.postMessage({message:"pr:poweredlink_text_color",params:o},e),parseInt($('input[name="hide_close_link"]').val())&&PCD.postMessage({message:"pr:hide_close_frame"},e),parseInt($('input[name="hide_close_frame"]').val())&&PCD.postMessage({message:"pr:hide_close_frame"},e),parseInt($('input[name="full_width_template"]').val())&&PCD.postMessage({message:"pr:full_width_template"},e);var p=parseInt($('input[name="wrap_click_close"]').val());p&&PCD.postMessage({message:"pr:wrap_click_close",params:p},e);var c=$('input[name="wrap_text_color"]').val();if(c&&PCD.postMessage({message:"pr:wrap_text_color",params:c},e),0<$('input[name="search_personal_match"]').val()){for(var l=/{{\*((.)*)}}/gim,m=$(".modal-body").html();null!==(tmp_repl=l.exec(m));)replace_data.matches.push(tmp_repl[0]),replace_data.selectors.push(tmp_repl[1]);0<replace_data.matches.length&&PCD.postMessage({message:"pr:replace_data",params:replace_data.selectors},e)}if(0<$("#picreel-recaptcha").length){$("#picreel-recaptcha").parents(".container").find(".submit").attr("disabled","disabled");var u=document.createElement("script");u.type="text/javascript",u.defer=!0,u.async=!0,u.src="https://www.google.com/recaptcha/api.js?onload=onLoadCallback&render=explicit",$("head").append(u)}},isEmail=function(e){return!(-1==e.search(/[_a-z0-9-]+(\.[_a-z0-9-]+)*(\+[a-z0-9-]+)?@[a-z0-9-]+\.[a-z0-9-]+(\.[_a-z0-9-]+)*/i))},isBriteDocsEmail=function(a){var e=$('input[name="briteverify"]').val(),t=$('input[name="briteverify"]').data("apikey");if(0<e&&20<t.length){var s=$('input[type="email"]').val();$.ajax({url:"//bpi.briteverify.com/emails.json?apikey="+t+"&address="+s,dataType:"jsonp"}).then(function(e){if("invalid"==e.status){var t=$body.find($(this).data("error-text"));return t.length?t.html(e.error):alert(e.error),$('input[type="email"]').focus(),!1}a()})}else a()},isPhone=function(e,t){return t||(t=/^\+?\d{0,13}$/i),!(-1==e.search(t))},subscribe=function(e,t){var a={};a.tech_data=$(".picreel_tech_data").serializeArray(),a.custom_data=e,$.ajax({url:subscribeUrl+"_new",type:"post",dataType:"json",crossDomain:!0,data:a,complete:t})},track_conversion=function(e){if(0<campaignId){if($(".container").hasClass("do-not-track-conversions"))return;var t={campaign_id:campaignId,template_id:templateId};$.ajax({url:actionUrl,type:"post",dataType:"jsonp",crossDomain:!0,jsonp:!1,data:t,complete:function(){"function"==typeof e&&e()}})}},collectDataToSubmit=function(){var i={};return form_inputs.each(function(){if($(this).hasClass("required")&&(""==$.trim($(this).val())||"checkbox"==$(this).attr("type")&&!0!==$(this).prop("checked"))&&"none"!==$(this).css("display")&&"hidden"!==$(this).attr("type")){if("checkbox"==$(this).attr("type")&&$(this).parents(".privacy-policy-container").is(":hidden"))return!0;var e=$body.find($(this).data("error-text"));return void 0===(a=$(this).data("required"))&&(a="You didn't fill all the fields"),e.length?e.html(a):($(this).addClass("wait-focus"),PCD.postMessage({message:"pr:show_alert",params:a},request_url)),$(this).focus(),i=!1}if("email"==$(this).prop("type")){var t=$(this).val();if(!isEmail(t)){var a="Please enter valid email address";return(e=$body.find($(this).data("error-text"))).length?e.html(a):($(this).addClass("wait-focus"),PCD.postMessage({message:"pr:show_alert",params:a},request_url)),$(this).focus(),i=!1}}if("radio"==$(this).prop("type")||"checkbox"==$(this).prop("type")){if(1==$(this).prop("checked")){var s=$.trim($(this).val()),r=$(this).attr("name");i[r]=s}}else{s=$.trim($(this).val()),r=$(this).attr("name");i[r]=s}}),i},ifExistingEmail=function(e,t){return"1"==must_redirect&&(""!==must_redirect_url&&"object"==typeof e.responseJSON&&"duplicate"==e.responseJSON.error?($(self).trigger("onPicExistingEmail"),PCD.postMessage({message:"pr:redirect",params:must_redirect_url},request_url)):t(),!0)},redirectTemplate=function(e){if(!t)var t=$('input[name="request_url"]').val()?$('input[name="request_url"]').val():e;"_blank"===$(".submit").attr("target")&&$(".submit").attr("href")&&""!==$(".submit").attr("href")?PCD.postMessage({message:"pr:close_after_submit",params:""},t):$(".container").hasClass("open-in-window")?(window.open(e,"Redirect window","top="+.05*screen_size.height+",left="+.05*screen_size.width+",resizable=yes,scrollbars=yes,width="+.9*screen_size.width+",height="+.8*screen_size.height),PCD.postMessage({message:"pr:close_after_submit",params:""},t)):PCD.postMessage({message:"pr:redirect",params:e},t)},closeTemplate=function(e){var t=$('input[name="request_url"]').val();e=void 0===e?"":e,PCD.postMessage({message:"pr:close_after_submit",params:e},t)},doFromEventStack=function(e){if(event_stack&&event_stack[e.type]){var t=event_stack[e.type],a=self;void 0===t.action&&(t.action="close");var s=a[t.action+"Template"];"function"==typeof s&&("redirect"==t.action&&parseInt($('input[name="send_leads_get"]').val())&&(t.parameters[0]+=setLeadDataToRedirect(t)),s.apply(a,t.parameters))}},receiveApiMessage=function(e){var t=e.data,a=$('input[name="request_url"]').val();if("showPopup"!=t.message&&"showPopup"!=t||$(self).trigger("onPicShowPopup"),"popupInitialized"==t.message&&afterPopupInit(),"picreel_track_data"==t.message)for(var s in t.params)$('input[id="'+s+'"]').val(t.params[s]);if("screen_size"==t.message&&(screen_size=JSON.parse(t.params)),"send_leads"==t.message){var r={},i=JSON.parse(t.params);if(0<i.length){for(var n=0;n<i.length;n++)r[i[n].name]=$.trim(i[n].val);var o={};o.tech_data=$(".picreel_tech_data").serializeArray(),o.custom_data=r,$.ajax({url:subscribeUrl+"_new",type:"post",dataType:"jsonp",crossDomain:!0,jsonp:!1,data:o,complete:function(){}})}}if("getCookieNames"==t.message){var p=$(".picreel_cookie_submit");if(p){var c=Array();for(n=0;n<p.length;n++)c.push($(p[n]).attr("name"))}c&&PCD.postMessage({message:"pr:cookieNames",params:c.join(",")},a)}if("cookieValues"==t.message)for(var s in t.params)$('input[name="'+s+'"]').val(t.params[s]);if("replaced_data"==t.message){var l=$(".modal-body").html();for(n=0;n<replace_data.matches.length;n++)l=l.replace(replace_data.matches[n],t.params[replace_data.selectors[n]]);$(".modal-body").html(l),form_inputs=getTemplateInputs(),initTemplateEvents()}"set_input_focus"==t.message&&($(".wait-focus").focus(),$(".wait-focus").removeClass("wait-focus"))},checkIE=function(){var e=-1;if("Microsoft Internet Explorer"==navigator.appName){var t=navigator.userAgent;null!=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(t)&&(e=parseFloat(RegExp.$1))}else if("Netscape"==navigator.appName){t=navigator.userAgent;null!=new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(t)&&(e=parseFloat(RegExp.$1))}return e},recaptchaCallback=function(e){$.ajax({method:"POST",url:"/api/checkCaptcha",data:{"g-recaptcha-response":e}}).done(function(e){!0===JSON.parse(e).status&&$("#picreel-recaptcha").parents(".container").find(".submit").removeAttr("disabled")}).fail(function(e,t){})},expCallback=function(){$("#picreel-recaptcha").parents(".container").find(".submit").attr("disabled","disabled")},onLoadCallback=function(){"undefined"!=typeof grecaptcha&&grecaptcha.render("picreel-recaptcha",{sitekey:"6LdzxDYUAAAAAHb7THJYhI_zZ4TmGIozKuBYImOZ",callback:recaptchaCallback,"expired-callback":expCallback})};